# Multi-Account Automated AWS Infrastructure

An enterprise-grade CI/CD pipeline that deploys a modular, multi-tier network architecture across a multi-account AWS Organization using **GitHub Actions**, **OIDC**, and **CloudFormation StackSets**.

---

## Network Configuration (`network-stack.template.yaml`)

The network layer defines a highly structured VPC environment:

* **VPC**: A Virtual Private Cloud is created with a default CIDR block of `10.10.0.0/16` and DNS support enabled.
* **Subnet Strategy**: The template uses the `Fn::Cidr` intrinsic function to programmatically carve the VPC into 12 equally sized subnets.
* **Tiered Architecture**: These 12 subnets are distributed across 3 **Availability Zones (AZs)** to ensure redundancy, categorized into four distinct tiers:
    * **Web Tier**: Three subnets for public-facing resources.
    * **App Tier**: Three subnets for application logic.
    * **DB Tier**: Three subnets dedicated to database workloads.
    * **Reserved Tier**: Three subnets held for future expansion.



### Connectivity:
* **Public Access**: An **Internet Gateway (IGW)** and a **Public Route Table** allow the Web Tier to communicate with the internet.
* **Private Egress**: A **NAT Gateway** is deployed in the first Web Tier subnet, allowing private subnets (App and DB tiers) to access the internet for updates without being reachable from the outside.

---

## Security Group Configuration (`security-stack.template.yaml`)

The security layer implements a **"Least Privilege"** model, where each tier only accepts traffic from the tier immediately above it:

| Security Group | Purpose | Ingress Rules |
| :--- | :--- | :--- |
| **WebServerSecurityGroup** | Public-facing entry point | Allows **HTTP (80)** and **HTTPS (443)** from any IP address (`0.0.0.0/0`). |
| **AppServerSecurityGroup** | Backend logic | Allows traffic on **Port 8080**, restricted specifically to traffic originating from the `WebServerSecurityGroup`. |
| **DBSecurityGroup** | Database storage | Allows **PostgreSQL (5432)** traffic, restricted specifically to traffic originating from the `AppServerSecurityGroup`. |



### Integration and Dependency
The two configurations are linked via the **Root Template** (`main.template.yaml`). The `VpcId` generated by the Network Stack is captured as an output and passed directly into the Security Stack as a parameter. This ensures the security groups are created within the correct network boundary.

---

## CI/CD Architecture Overview

The project uses a **Hub-and-Spoke** deployment model. The **"Hub"** (Management Account) orchestrates the deployment into the **"Spoke"** (Member Account).

* **Modular Networking**: Decoupled templates for Network (VPC/Subnets) and Security (Groups/Rules).
* **Nested Stacks**: A `main.template.yaml` acts as the root orchestrator, passing outputs (like `VpcId`) from the Network stack to the Security stack.
* **Automated CI/CD**: Triggered by pushes to the `main` branch, utilizing `cfn-lint` for pre-deployment validation.



### Technical Stack
* **Infrastructure as Code**: AWS CloudFormation (Nested Stacks)
* **CI/CD**: GitHub Actions
* **Security/Identity**: OpenID Connect (OIDC) for passwordless AWS authentication
* **Orchestration**: AWS CloudFormation StackSets (Self-Managed Model)
* **Linter**: `cfn-lint`

---

## Prerequisites & Setup

This solution requires a specific **"handshake"** between the Management and Member accounts to support Nested Stacks.

### 1. Identity & Access (Management Account)
* **OIDC Provider**: Configured to trust GitHub Actions.
* **IAM Role (`GitHubDeploymentRole`)**: Assumed by GitHub to package artifacts and manage StackSets.
* **IAM Role (`AWSCloudFormationStackSetAdministrationRole`)**: Used by CloudFormation to assume roles in member accounts.

### 2. The Execution Handshake (Member Account)
* **IAM Role (`AWSCloudFormationStackSetExecutionRole`)**: Created in the member account with `AdministratorAccess`.
* **Trust Relationship**: This role must trust the Management Account root (`arn:aws:iam::123456789012:root`) to allow cross-account execution.

### 3. S3 Artifact Storage
* **Bucket (`cloudformation-templates-dev-8746`)**: Located in `us-east-1`. Used by the `aws cloudformation package` command to store nested templates.

---

## Deployment Pipeline

The workflow defined in `deploy.yaml` automates the following stages:

1.  **Linting**: Validates CloudFormation syntax. Note the use of **Metadata** in templates to bypass `W3002` (local path warnings) during the packaging phase.
2.  **Packaging**: The CLI converts local relative paths in the root template to S3 URLs, generating a `packaged.yaml`.
3.  **Idempotent Deployment**:
    * Checks if the StackSet `Proj1-Dev-Infrastructure` exists.
    * If it exists, it performs an **Update**.
    * If not, it performs a **Create** and initializes **Stack Instances** in the target member account.

---

## Project Structure

* `main.template.yaml`: The entry point. Orchestrates the nested `NetworkStack` and `SecurityStack`.
* `network-stack.template.yaml`: Creates a VPC with 12 subnets across 3 Availability Zones (Web, App, DB, and Reserved tiers).
* `security-stack.template.yaml`: Establishes a 3-tier security group hierarchy (Web -> App -> DB).
* `.github/workflows/deploy.yaml`: The GitHub Actions CI/CD definition.

---

## Security & Secrets Management

To adhere to the Principle of Least Privilege and prevent sensitive data exposure, this project utilizes a hardened CI/CD security posture:

**GitHub Actions OIDC:** Instead of storing long-lived AWS Access Keys, this pipeline uses OpenID Connect (OIDC) to assume an IAM Role dynamically. This eliminates the risk of credential leakage.

**Infrastructure Masking:** All AWS Account IDs (Management and Member) are stored as GitHub Actions Secrets. This ensures that the public repository contains only the architectural logic, while environment-specific identifiers remain private.

**Cross-Account Handshake:** Deployment is managed via a Self-Managed StackSet model. A secure trust relationship is established between the Management Account and the Member Account via the AWSCloudFormationStackSetExecutionRole.

**S3 Artifact Protection:** Deployment templates are packaged and stored in a private S3 bucket with a Restrictive Bucket Policy that only grants access to the specific deployment roles involved in the handshake.

---

## Verification

To verify the deployment status via the AWS CLI from the Management Account:

**Check overall StackSet status**
```bash
aws cloudformation describe-stack-set --stack-set-name Proj1-Dev-Infrastructure
```

**Check status in the specific Member Account**
```bash
aws cloudformation list-stack-instances --stack-set-name Proj1-Dev-Infrastructure --stack-instance-account 123456789012
```

---

## Architecture

```
[ GitHub Repository ]
       |
       | (1) Push to 'main'
       v
[ GitHub Actions Runner ]
       |
       | (2) OIDC Auth (AssumeRole)
       | (3) Package & Upload Templates
       v
+-----------------------------+          +---------------------------+
|    Management Account       |          |      Member Account       |
|      (Hub / Admin)          |          |     (Spoke / Target)      |
|                             |          |                           |
|  +-----------------------+  |          |  +---------------------+  |
|  |   S3 Artifact Bucket  |--|---(4)------>|  CloudFormation     |  |
|  | (Templates/Artifacts) |  |   Pull   |  |   Execution Role    |  |
|  +-----------------------+  |          |  +---------------------+  |
|              |              |          |             |             |
|  +-----------------------+  |          |  +---------------------+  |
|  |  CFN StackSet Admin   |--|---(5)------>|   Deployed Stack    |  |
|  |      (Control)        |  |  Update  |  |    (VPC, Subnets)   |  |
|  +-----------------------+  |          |  +---------------------+  |
+-----------------------------+          +---------------------------+
```