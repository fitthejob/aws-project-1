name: Deploy CloudFormation Stacks
on:
  push:
    branches: [ main ]

permissions:
  id-token: write 
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::205500199161:role/GitHubDeploymentRole
          aws-region: us-east-1

      - name: Lint Templates
        run: |
          pip install cfn-lint
          cfn-lint -t **/*.yaml 

      - name: Package and Deploy (Self-Managed)
        run: |
          # 1. Package the nested templates
          aws cloudformation package \
            --template-file main.template.yaml \
            --s3-bucket cloudformation-templates-dev-8746 \
            --output-template-file packaged.yaml

          # 2. Check if StackSet exists to decide between Create or Update
          if aws cloudformation describe-stack-set --stack-set-name Proj1-Dev-Infrastructure --region us-east-1 > /dev/null 2>&1; then
            echo "StackSet exists. Updating..."
            aws cloudformation update-stack-set \
              --stack-set-name Proj1-Dev-Infrastructure \
              --template-body file://packaged.yaml \
              --permission-model SELF_MANAGED \
              --administration-role-arn arn:aws:iam::205500199161:role/AWSCloudFormationStackSetAdministrationRole \
              --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
              --region us-east-1
          else
            echo "StackSet does not exist. Creating..."
            aws cloudformation create-stack-set \
              --stack-set-name Proj1-Dev-Infrastructure \
              --template-body file://packaged.yaml \
              --permission-model SELF_MANAGED \
              --administration-role-arn arn:aws:iam::205500199161:role/AWSCloudFormationStackSetAdministrationRole \
              --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND \
              --region us-east-1

            # Only create instances on the first run (initial creation)
            aws cloudformation create-stack-instances \
              --stack-set-name Proj1-Dev-Infrastructure \
              --accounts "017677777575" \
              --regions "us-east-1"
          fi